{% extends "base.html" %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{% load i18n %}
{% block title %}{{ bom.title|default:bom.DEFAULT_TITLE }} | {% endblock title %}
{% block extra_head %}
    <script src="{% static 'js/autoGrowArea.js' %}"></script>
    {% block draw_extra_head %}{% endblock draw_extra_head %}
{% endblock extra_head %}
{% block extra_jq_ready %}
    // TODO This is overwritten in random_item.html (and others). Fix it
    // When fields are focused, all the content is pre-selected
    $('.form-control').click(function() {
      $(this).select();
    });

    // Autoresize the title box when window is resized
    autosize = function(){
        var max_width = $("#draw-title-container").width()*2/3;
        $("textarea.autogrow").width(max_width);
        $("textarea.autogrow").autoGrowInput({title:'{{ bom.title|default:bom.DEFAULT_TITLE }}',maxWidth: max_width,minWidth:30,comfortZone:30});
    };

    // Autosize the first time
    autosize();
    $( window ).resize(function() {
        // Autosize when the window is resized
        autosize();
    });

    // Disable submit button after submitting
    $('form').submit(function() {
        $(this).find("button[type='submit']").prop('disabled',true);
    });
    $('.accordion').accordion({collapsible: true});

    // Update draw's password
    $('.change-password').click(function(){
        $('#id_password').val($('#draw-password').val());
    });
    {% block draw_extra_jq_ready %}{% endblock draw_extra_jq_ready %}
{% endblock extra_jq_ready %}
{% block content %}
    <div class="row">
        <form class="clearfix" method="post">
            <!-- Draw Heading -->
            <div class="clearfix draw-heading">
                <a href="{% url 'index' %}" class="back-arrow col-xs-2 col-sm-2 text-center">
                    <img src="{% static "img/back_arrow.png" %}"/>
                </a>
                <div class="col-xs-8 visible-xs"></div>
                {% if is_public%}
                    <a data-toggle="modal" href="#modal" class="add-password col-xs-2 col-sm-2 col-sm-push-8 text-center">
                        <i class="fa fa-unlock fa-3x"></i>
                    </a>
                {% else %}
                    <a href="#" class="add-favorites col-xs-2 col-sm-2 col-sm-push-8 text-center">
                        <img src="{% static "img/favorite.png" %}"/>
                    </a>
                {% endif %}
                <div id="draw-title-container" class="col-xs-12 col-sm-8 col-sm-pull-2 text-center">
                    <textarea name="title" class="form-control autogrow draw-title-area text-center" rows="1">{{ bom.title|default:bom.DEFAULT_TITLE }}</textarea>
                </div>
            </div>
            <!-- End Draw Heading -->

            <div class="col-sm-8 col-sm-offset-2">
                {%block pre_draw %} {%endblock pre_draw%}
                <!-- Errors -->
                {%for err in errors %}
                    <div class="alert alert-danger text-center" role="alert">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        {{err}}
                    </div>
                {% endfor  %}
                <!-- Input Form -->
                {% crispy draw draw.helper %}
                <div class="col-xs-12 text-center">
                    {% if is_public %}
                        <button type="submit" name="try" class="btn btn-success ">Try it!</button>
                        <button type="submit" name="next" class="btn btn-primary">Next</button>
                    {% else %}
                        <button type="submit" name="toss" class="btn btn-success btn-toss">Toss</button>
                    {% endif %}
                </div>
            </div>
        </form>
        <!-- End Input Form -->
        <!-- Results -->
        <div class="col-sm-8 col-sm-offset-2">
            <div class="row text-center accordion">
            {% for result in bom.results reversed %}
            {% with result.items as results%}
                {% if results %}
                    <p class="h3">
                        {%trans 'Result' %}{{results|length|pluralize}}
                        <small class="visible-xs-inline">{{result.datetime|date:"d/m/y H:i:s"}}</small>
                        <small class="result-timestamp hidden-xs">{%trans ' generated on '%}{{result.datetime|date:"d M Y, H:i:s"}}</small>
                    </p>
                    <div >
                        {% block result %}{% endblock result %}

                    </div>
                {% endif %}
            {% endwith %}
            {% endfor %}
            <!-- Previous draw -->
            {% if bom.prev_draw %}
                <p class="h3">{%trans 'Result' %}{{results|length|pluralize}}<small>{%trans ' generated before '%}</small></p>
                <div >
                   {%trans 'The configuration of the draw was changed.'%}<br/>
                   {%trans 'This is the previous version: '%}<a href="{%url 'retrieve_draw' draw_id=bom.prev_draw %}">{{ bom.title|default:bom.DEFAULT_TITLE }}</a>

                </div>
            {% endif %}
            </div>
            <!-- End Results -->
        </div>
    </div>

    <div id="modal" class="modal fade" tabindex="-1" style="display: none;" data-focus-on="input:first">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Set up a password</h4>
            </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                        Restrict the access to the draw by setting up a password. Leave it in blank if you don't want to use it

                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-lock"></i></span>
                                <input id="draw-password" type="password" class="form-control has-clear" name="password" placeholder="Password">
                            </div>
                        </div>
                    </div>
                </div>
            <div class="modal-footer">
            <button type="button" data-dismiss="modal" class="btn btn-default">Cancel</button>
            <button type="button" class="btn btn-primary change-password">Save</button>
        </div>
    </div>
{% endblock %}


